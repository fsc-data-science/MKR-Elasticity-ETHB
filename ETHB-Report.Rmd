---
title: "MKR ETH-B Vault Report"
author: "Charliemarketplace // Data Science @FlipsideCrypto"
date: "`r Sys.Date()`"
output:
  html_document:
    css: "styles.css"
    includes:
      in_header: header.html
    code_folding: hide
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(reactable)
library(TTR) # RSI
library(zoo) # fill NAs
library(plotly)
library(dplyr)
library(lubridate)

dai_out_fee_price <- read.csv("ethb_dai_fulldata.csv", row.names = NULL)
parameter_changes <- read.csv("ETHB-Parameter-Changes.csv", row.names = NULL)

# for better plotting
parameter_changes$TIMESTAMP_posixct <- as.POSIXct(parameter_changes$TIMESTAMP, tz = "UTC")
parameter_changes$TIMESTAMP_date <- as.Date(parameter_changes$TIMESTAMP, tz = "UTC")

debt_changes <- parameter_changes[parameter_changes$PARAMETER %in% 
                                    c('DC-IAM.ilks.line','VAT.ilks.line'), ]


fee_changes <- parameter_changes[parameter_changes$PARAMETER == 'JUG.ilks.duty', c("BLOCK","TIMESTAMP", "FROM_VALUE","TO_VALUE")]

fee_changes$TIMESTAMP_posixct <- as.POSIXct(fee_changes$TIMESTAMP, tz = "UTC")
fee_changes$TIMESTAMP_date <- as.Date(fee_changes$TIMESTAMP, tz = "UTC")
fee_changes[16, ] <- fee_changes[15, ]
# to fill out plots add a filler date 
fee_changes[16, c("FROM_VALUE", "TIMESTAMP_date", "day")] <- c(0.0300, "2023-01-13", "2023-01-13")

```

FlipsideCryptoâ€™s Research is open source. Check out all the code for this report [here](https://github.com/fsc-data-science/MKR-Elasticity-ETHB/) on github.

# Intro 

This report takes visualizations from the [maker_ethb_viz](https://science.flipsidecrypto.xyz/maker_ethb_viz/) exploratory data analysis
and adds context and recommendations for Maker's risk team.

# Key Points 

- There is no conclusive evidence that users of Maker ETH-B Vault are elastic to stability fee.
- Daily Implied Revenue for the ETH-B Vault peaked at a high fee period, even though Dai Outstanding 
peaked in a low fee period.
- The key driver of ETH B utilization is ETH's Price action.

All this said, the analysis was severely limited by 2 confounding factors:

- The early days of ETH B where the Debt Ceiling reached the Debt Limit.
- The stability fee exclusively decreased from Dec 2021 to Jan 2023.   

# Historical Context 

## Stability Fee vs Debt Ceiling (Keeper) vs Debt Limit (Gov)
 
The ETHB Vault has both a Debt Ceiling and Debt Limit.

- Debt Ceiling: `VAT.ilks.line` limits excessive short-term 
minting of DAI and can be raised by anyone as needed. 
Maker uses a Keeper setup to keep this limit close to the amount of outstanding DAI 
from a Vault to protect against certain attack vectors, e.g., a flashloan within a single block
that could be used exploit liquidity.

- Debt Limit: `DC-IAM.ilks.line` is a hard limit to the amount of DAI that can be 
generated by a vault. It is determined by governance and is set extremely high, allowing 
the Debt Ceiling to be the main (soft) constraint for DAI generation.

```{r}

debt_ceiling <- plot_ly() %>% add_trace(data = debt_changes,
                        x = ~TIMESTAMP_date, 
                        y = ~TO_VALUE, 
                        color = ~PARAMETER,
            line = list(shape = 'hv'), # stepwise changes
         text = paste('Block: ', debt_changes$BLOCK,
                        '<br>Timestamp: ', debt_changes$TIMESTAMP_posixct,
                        '<br>From: ',debt_changes$FROM_VALUE,
                        'To: ', debt_changes$TO_VALUE),
         hoverinfo = 'text',
        type = "scatter", mode = "markers+lines") %>% 
  layout(
    xaxis = list(title = "Date"),
    yaxis = list(title = "Debt Limit"), 
    title = list(text = "Historical Changes to ETH-B Debt Ceiling & Limit", y = 0.975)
  ) %>% 
  add_trace(x = fee_changes$TIMESTAMP_date, 
            y = ~fee_changes$TO_VALUE*100*10e6,
            text = paste('Date: ', fee_changes$TIMESTAMP_date,
                         '<br>Fee: ', 100*fee_changes$TO_VALUE,"%"),
            hoverinfo = 'text',
            name = 'Stability Fee % (scaled)', 
            type= "scatter",
            mode = "markers+lines", 
            line = list(shape = 'hv'))

debt_ceiling


```

## ETHB before July 2021 

Zoom in, Demand at 50M DAI was very inelastic, vault was new. Only once has 
DAI outstanding fallen to < 50M since (July 8 2022) and it did so for only a few days.

```{r}
# lubridate
min_Date <- ymd_hms("2020-12-21 00:00:00")
min_Date_ms <- interval("1970-01-01 00:00:00", min_Date) / dmilliseconds(1)
max_Date <- ymd_hms("2021-07-13 00:00:00")
max_Date_ms <- interval("1970-01-01 00:00:00", max_Date) / dmilliseconds(1)

debt_ceiling %>% layout(
  xaxis = list(range = c(min_Date_ms, max_Date_ms)),
  yaxis = list(range = c(0, 110e6))
)

```


# DAI Outstanding & Implied Revenue

Revenue peaked at high fee, medium-dai outstanding; while dai outstanding
maximized at low fee (but still brought a small spike in revenue).


```{r}


```

# Implied Revenue vs Stability Fee

There may be a laffer curve relationship between revenue and stability fee. 

# ETH Price & RSI 


# DAI Outstanding Spike 1

ETH Price runs up, DAI Outstanding & Revenue skyrocket.

# DAI Outstanding Spike 2

ETH Price collapses, becomes oversold by RSI, leverage longs use DAI vault. 
ETH bouneces from 995 -> 1240 over 20 days.

# Conclusion 

While we see the high correlation between DAI Outstanding, Implied Revenue, and 
ETH Price. There is no correlation between DAI Outstanding and the Stability Fee.
Whether in the totality of the time period or since June 2021.

```{r}
cor(dai_out_fee_price$dai_outstanding[210:822], dai_out_fee_price$TO_VALUE[210:822])
```

The path forward for identifying how to best set the stability fee for Maker's goals is 
to experiment with the fee. We recommend a preset growth of the stability fee from the current 
to 6.5%, 0.5% at a time over equal defined time periods, ignoring all factors: ETH price, RSI, competitors, revenue, dai outstanding. 

This would enable a natural experiment for formal modeling could parse out the effects 
of stability fee increases across changes in ETH's price and RSI over time.






