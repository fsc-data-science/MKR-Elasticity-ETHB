---
title: "MKR ETH-B Vault Report"
author: "Charliemarketplace // Data Science @FlipsideCrypto"
date: "`r Sys.Date()`"
output:
  html_document:
    css: "styles.css"
    includes:
      in_header: header.html
    code_folding: hide
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(scipen = 99)
library(reactable)
library(TTR) # RSI
library(zoo) # fill NAs
library(plotly)
library(dplyr)
library(lubridate)

dai_out_fee_price <- read.csv("ethb_dai_fulldata.csv", row.names = NULL)


parameter_changes <- read.csv("ETHB-Parameter-Changes.csv", row.names = NULL)

# for better plotting
parameter_changes$TIMESTAMP_posixct <- as.POSIXct(parameter_changes$TIMESTAMP, tz = "UTC")
parameter_changes$TIMESTAMP_date <- as.Date(parameter_changes$TIMESTAMP, tz = "UTC")

debt_changes <- parameter_changes[parameter_changes$PARAMETER %in% 
                                    c('DC-IAM.ilks.line','VAT.ilks.line'), ]


fee_changes <- parameter_changes[parameter_changes$PARAMETER == 'JUG.ilks.duty', c("BLOCK","TIMESTAMP", "FROM_VALUE","TO_VALUE")]

fee_changes$TIMESTAMP_posixct <- as.POSIXct(fee_changes$TIMESTAMP, tz = "UTC")
fee_changes$TIMESTAMP_date <- as.Date(fee_changes$TIMESTAMP, tz = "UTC")
fee_changes[16, ] <- fee_changes[15, ]
# to fill out plots add a filler date 
fee_changes[16, c("FROM_VALUE", "TIMESTAMP_date", "day")] <- c(0.0300, "2023-01-13", "2023-01-13")

```

FlipsideCryptoâ€™s Research is open source. Check out all the code for this report [here](https://github.com/fsc-data-science/MKR-Elasticity-ETHB/) on github.

# Intro 

This report takes visualizations from the [maker_ethb_viz](https://science.flipsidecrypto.xyz/maker_ethb_viz/) exploratory data analysis
and adds context and recommendations for Maker's risk team.

# Key Points 

- There is no conclusive evidence that users of Maker ETH-B Vault are elastic to the stability fee.
- Daily Implied Revenue for the ETH-B Vault peaked at a high fee period, even though DAI Outstanding 
peaked in a low fee period.
- The key driver of ETH B utilization is ETH's Price action.

All this said, the analysis was severely limited by 2 confounding factors:

- The early days of ETH B where the Debt Ceiling reached the Debt Limit.
- The stability fee exclusively decreased from Dec 2021 to Jan 2023.   

# Historical Context 

## Stability Fee vs Debt Ceiling (Keeper) vs Debt Limit (Gov)
 
The ETHB Vault has both a Debt Ceiling and Debt Limit.

- Debt Ceiling: `VAT.ilks.line` limits excessive short-term 
minting of DAI and can be raised by anyone as needed. 
Maker uses a Keeper setup to keep this limit stays close to the amount of outstanding DAI 
from a Vault to protect against certain attack vectors, e.g., a flashloan within a single block
that could be used to exploit liquidity.

- Debt Limit: `DC-IAM.ilks.line` is a hard limit to the amount of DAI that can be 
generated by a vault. It is determined by governance and is set extremely high, allowing 
the Debt Ceiling to be the main (soft) constraint for DAI generation.

```{r}

debt_ceiling <- plot_ly() %>% add_trace(data = debt_changes,
                        x = ~TIMESTAMP_date, 
                        y = ~TO_VALUE, 
                        color = ~PARAMETER,
            line = list(shape = 'hv'), # stepwise changes
         text = paste('Block: ', debt_changes$BLOCK,
                        '<br>Timestamp: ', debt_changes$TIMESTAMP_posixct,
                        '<br>From: ',debt_changes$FROM_VALUE,
                        'To: ', debt_changes$TO_VALUE),
         hoverinfo = 'text',
        type = "scatter", mode = "markers+lines") %>% 
  layout(
    xaxis = list(title = "Date"),
    yaxis = list(title = "Debt Limit"), 
    title = list(text = "Historical Changes to ETH-B Debt Ceiling & Limit", y = 0.975)
  ) %>% 
  add_trace(x = fee_changes$TIMESTAMP_date, 
            y = ~fee_changes$TO_VALUE*100*10e6,
            text = paste('Date: ', fee_changes$TIMESTAMP_date,
                         '<br>Fee: ', 100*fee_changes$TO_VALUE,"%"),
            hoverinfo = 'text',
            name = 'Stability Fee % (scaled)', 
            type= "scatter",
            mode = "markers+lines", 
            line = list(shape = 'hv'))

debt_ceiling


```

## ETHB before July 2021 

In the first 7 months of ETHB, the Debt Limit of 50M DAI was quickly reached. 
Consistent increases in the stability fee did lead to some withdrawals and paybacks, 
but ultimately, the demand for DAI was extremely inelastic to stability fee at 50M Debt Ceiling.

Zooming in, after 4 increases of the stability fee (6.5%, 7.5%, 9%, 10%) failed to reduce demand,
governance separated the Debt Ceiling from the Debt Limit enabling more DAI to be generated.


```{r}
# lubridate
min_Date <- ymd_hms("2020-12-21 00:00:00")
min_Date_ms <- interval("1970-01-01 00:00:00", min_Date) / dmilliseconds(1)
max_Date <- ymd_hms("2021-07-13 00:00:00")
max_Date_ms <- interval("1970-01-01 00:00:00", max_Date) / dmilliseconds(1)

debt_ceiling %>% layout(
  xaxis = list(range = c(min_Date_ms, max_Date_ms)),
  yaxis = list(range = c(0, 110e6))
)

```

In fact only once after August 2021 did the Debt Ceiling fall to < 50M (July 2022) and it did so for only a few days.

```{r}
debt_ceiling %>% layout(
  yaxis = list(range = c(30e6, 110e6))
)
```

# DAI Outstanding & Implied Revenue

## DAI Oustanding 

DAI Outstanding from ETH B peaked in June 2022 at ~230M DAI. The stability fee 
at the time was 4%. 

```{r}
plot_ly() %>% 
  add_trace(data = dai_out_fee_price, x = ~day, y = ~dai_outstanding, 
            type = "scatter", mode = "markers+lines", name = "ETHB: Dai Outstanding") %>% 
   layout(
    xaxis = list(title = "Date"),
    yaxis = list(title = "# of DAI"), 
    title = list(text = "Net DAI in circulation from ETHB", y = 0.975)) %>% 
  add_trace(x = fee_changes$TIMESTAMP_date, 
            y = ~fee_changes$TO_VALUE*100*10e6,
            text = paste('Date: ', fee_changes$TIMESTAMP_date,
                         '<br>Fee: ', 100*fee_changes$TO_VALUE,"%"),
            hoverinfo = 'text',
            name = 'Stability Fee % (scaled)', 
            type= "scatter",
            mode = "markers+lines", 
            line = list(shape = 'hv'))

```

## Implied Revenue 

Implied Revenue is calculated at the daily level as: 

`daily_implied_revenue = dai_outstanding * stability_fee / 365`

This relatively simple calculation unifies the competing priorities of Maker. 

- Making more revenue improves the protocol's strength and enables more funding for the DSR. 
- Having more DAI in the ecosystem allows it to to more easily integrate into DeFi where 
it can be demanded as a unified decentralized stablecoin.

This chart contrasts with the DAI Outstanding chart, as it shows revenue peaked when the 
stability fee was growing from 5% to 6.5% around Nov 2021, despite the DAI Outstanding 
being 30% lower than peak at ~160M DAI.

```{r}

plot_ly() %>% add_trace(data = dai_out_fee_price, x = ~day, y = ~implied_revenue, 
            type = "scatter", mode = "markers+lines",
            name = "Implied Revenue") %>% 
   layout(xaxis = list(title = "Date"),
    yaxis = list(title = "DAI Revenue"),
     title = list(text = "ETHB Daily Implied Revenue in DAI", y = 0.975)) %>% 
  add_trace(x = fee_changes$TIMESTAMP_date, 
            y = ~fee_changes$TO_VALUE*100*1000,
            text = paste('Date: ', fee_changes$TIMESTAMP_date,
                         '<br>Fee: ', 100*fee_changes$TO_VALUE,"%"),
            hoverinfo = 'text',
            name = 'Stability Fee % (scaled)', 
            type= "scatter",
            mode = "markers+lines", 
            line = list(shape = 'hv'))

```

# Implied Revenue vs Stability Fee

In tax theory, the [Laffer Curve](https://en.wikipedia.org/wiki/Laffer_curve) 
states that government revenue is 0 at both 0% tax rate and 100% tax rate, and thus 
there is concavity around an optimal tax rate that enables economic growth while also 
maximizing government revenue. 

There may similarly be a Laffer Curve relationship between ETHB daily implied revenue and 
the stability fee.

This Loess (locally estimated scatterplot smoothing) view obscures a lot of confounding factors (i.e., ETH Price and limited number of changes to stability fees), but separating out the data for after July 2021 
does provides shallow support to the argument that users are generating DAI with little 
care for the direct cost.

```{r}

lsmooth <- stats::lowess(
  dai_out_fee_price[dai_out_fee_price$day >= '2021-07-01', ]$implied_revenue ~ dai_out_fee_price[dai_out_fee_price$day >= '2021-07-01', ]$TO_VALUE)

lsmooth <- unique(as.data.frame(lsmooth))

plot_ly() %>% 
  add_trace(data = dai_out_fee_price[dai_out_fee_price$day >= '2021-07-01', ], 
        x = ~TO_VALUE*100, y = ~implied_revenue, name = "After July 2021",
        type = 'box',  boxpoints = "all", jitter = 0.1, pointpos = -1.8) %>% 
  add_trace(data = dai_out_fee_price[dai_out_fee_price$day < '2021-07-01', ], 
        x = ~TO_VALUE*100, y = ~implied_revenue, name = "Before July 2021",
        type = 'box',  boxpoints = "all", jitter = 0.1, pointpos = 1.8) %>% 
  layout(
    xaxis = list(title = "Stability Fee %"),
    yaxis = list(title = "Daily Implied Revenue (# DAI)"),
    title = list(text = "ETHB: Implied Revenue vs Stability Fee \n First 6 months separated",
                 y = 0.975)
  ) %>% 
  add_trace(data = lsmooth, x = ~x*100, y = ~y,  
               type = "scatter", mode = "lines", 
            name = "Loess Smooth \n(AFTER July 2021 Only)", 
               line = list(color = "black", width = 2, dash = 'dash'))

```

# ETH Price & RSI 

## DAI Outstanding Nov '21 Spike

DAI Outstanding has a noticeably high 0.491 correlation with ETH's Price. What is 
most interesting is the two major peaks in DAI Oustanding are the November 2021 peak
of the bull market and the June 2022 bottom of the market (where ETH fell to <$1,000).

In the first instance, the stability fee rose, we assume governance did so consciously to take advantage of demand and grow revenue. These kinds of active choices confound analysis like this, which will be discussed in the conclusion.

In the latter, the stability fee remained unchanged through the entire spike.

```{r}
dai_ethprice_correlation <- cor(dai_out_fee_price$dai_outstanding, dai_out_fee_price$price)

plot_ly() %>% 
  add_trace(data = dai_out_fee_price, x = ~day, y = ~dai_outstanding, 
            type = "scatter", mode = "markers+lines", name = "Dai from ETHB") %>% 
   layout(
    xaxis = list(title = "Date"),
    yaxis = list(title = "# of DAI"), 
    title = list(text = paste0("DAI Outstanding & ETH Price \n",
                               "Correlation: ", 
                               round(dai_ethprice_correlation, 3)), y = 0.975)) %>% 
  add_trace(x = fee_changes$TIMESTAMP_date, 
            y = ~fee_changes$TO_VALUE*100*10e6,
            text = paste('Date: ', fee_changes$TIMESTAMP_date,
                         '<br>Fee: ', 100*fee_changes$TO_VALUE,"%"),
            hoverinfo = 'text',
            name = 'Stability Fee % (scaled)', 
            type= "scatter",
            mode = "markers+lines", 
            line = list(shape = 'hv')) %>% 
  add_trace(data = dai_out_fee_price, x = ~day, y = ~price*10000, name = "ETH Price (scaled)",
            type = "scatter", mode = "lines",
             text = paste('Date: ', dai_out_fee_price$day,
                         '<br>Price: ', dai_out_fee_price$price,
                         '<br>RSI: ', floor(dai_out_fee_price$RSI)),
            hoverinfo = 'text')

```

## DAI Outstanding June '22 Spike

The DAI Outstanding spike of June 2022 coincides with a significant and rapid decrease in 
ETH's price. Looking at the Relative Strength Index (RSI), a traditional finance measure of 
an asset being overbought (>70) or oversold (<30), shows 11 days of Oversold status for ETH's Price
coinciding with very large and quick DAI generation events.

The reason one would mint DAI at ETH's local low would be to take leverage. You mint DAI, 
buy ETH, deposit that ETH and repeat the process. On June 19, 2022 ETH was at its lowest $995, with 
223,000,000 DAI Outstanding from this Vault. On July 8, 2022, with ETH's price recovering to 
$1,240 the DAI Outstanding was down nearly 90% to 23,280,000 DAI.

The smaller but still noticeable (-0.21) negative correlation with RSI indicates that DAI generation 
can occur even when ETH's price is low, (i.e., if it is oversold quickly).

This again supports the perspective that users are not elastic to the stability fee, they are 
reactive to ETH's price and its relative change in price.

```{r}
dai_ethrsi_correlation <- cor(dai_out_fee_price$dai_outstanding, dai_out_fee_price$RSI)

# have to use as.Date b/c previous charts had stability fee enforcing date xaxis
plot_ly() %>% 
  add_trace(data = dai_out_fee_price, x = ~as.Date(day), y = ~dai_outstanding, 
            type = "scatter", mode = "markers+lines", name = "Dai from ETHB") %>% 
   layout(
    xaxis = list(title = "Date"),
    yaxis = list(title = "# of DAI"), 
    title = list(text = paste0("DAI Outstanding & ETH RSI \n",
                               "Correlation: ", 
                               round(dai_ethrsi_correlation, 3)), y = 0.975)) %>% 
  add_trace(x = ~day, y = ~floor(RSI)*1e6, type = "scatter", mode = "lines", name = "RSI (scaled)") %>% 
  add_trace(data = dai_out_fee_price[dai_out_fee_price$RSI >= 70, ],
            x = ~day, y = ~floor(RSI)*1e6, type = "scatter", mode = "markers", name = "Overbought") %>% 
  add_trace(data = dai_out_fee_price %>% filter(RSI <= 30),
            x = ~day, y = ~floor(RSI)*1e6, type = "scatter", mode = "markers", name = "Oversold")

```


# Conclusion 

While we see the noticeable correlation between DAI Outstanding, 
ETH Price, and ETH RSI. There is no correlation between DAI Outstanding and the Stability Fee.
Whether in the totality of the time period or since June 2021 (Correlation: `r round( cor(dai_out_fee_price$dai_outstanding[210:822], dai_out_fee_price$TO_VALUE[210:822]),3)`)

We believe the path forward for identifying how to best set the stability fee for Maker's goals is to experiment with the fee. We recommend a preset growth of the stability fee from the current 
3% up to 6.5%, 0.5% at a time, over equal length time periods, ignoring all other factors: ETH price, RSI, competitors, revenue, DAI outstanding, etc.

This would enable a natural experiment. As ETH's price (and RSI) fluctuate, given an unbiased fee strategy, formal modeling could parse out the marginal effects 
of stability fee increases after adjusting for changes in ETH's price and RSI. 

We expect high volatility periods for ETH will draw increased revenue as the fee grows. We can then follow up this defined time period with structured decreases, again, ignoring all other factors to study the marginal effects in reverse. 

With more data and an unbiased fee strategy, more and better analysis can be done to inform 
fee strategies and methodologies for Maker stability fees on other vaults beyond ETHB.
